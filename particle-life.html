<html>
<title>Life</title>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            color-scheme: dark;
            --canvas-bg-color: rgba(0, 0, 0, 0);
            /* transparent */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #canvas {
            border: #504e52;
            border-style: dashed;
            border-width: 5;
            outline: none;
            /* because of the 'tabindex' focus trick */
            background-color: var(--canvas-bg-color);
        }
    </style>
</head>

<body>
    <canvas id="life" width="500" height="500"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.17"></script>
    <script>
        //edited from https://github.com/hunar4321/particle-life

        m = document.getElementById("life").getContext("2d");

        defaultColorSetting = (c, on) => {
            return {
                color: c,
                onOff: on,
                consumeSizeUp: 1,
                sizeLimit: 15,
                deathEvent: "nothing",
                canConsume: ["red"],
                detectionRange: 30,
            }
        }

        settings = {
            Pause: false,
            Speed: 1,
            Gravity: 1.0,
            colors: [
                defaultColorSetting("red", true),
                defaultColorSetting("orange", true),
                defaultColorSetting("yellow", true),
                defaultColorSetting("green", true),
                defaultColorSetting("aqua", false),
                defaultColorSetting("blue", false),
                defaultColorSetting("violet", false),
            ],
            rules: [],
            Random: () => { randomRules() },
            gui: null,
        }

        Object.defineProperty(String.prototype, 'capitalise', {
            value: function () {
                return this.charAt(0).toUpperCase() + this.slice(1);
            },
            enumerable: false
        })

        const setupGUI = () => {
            settings.gui = new lil.GUI();
            //game settings
            const settingGame = settings.gui.addFolder('Game Settings');
            settingGame.add(settings, 'Pause');
            settingGame.add(settings, 'Speed', -10, 10, 0.1);
            settingGame.add(settings, 'Gravity', 0, 10, 0.1);
            settingGame.add(settings, 'Random').name("Randomize Rules");

            //particle on/off
            const settingParticles = settings.gui.addFolder('Particle ON/OFF');
            for (var i = 0; i < settings.colors.length; i++) {
                element = settings.colors[i];

                settingParticles.add(element, "onOff")
                    .name(`<font color=\'${element.color}\'>${element.color.capitalise()}</font>`);
            }

            //particle rules
            for (var i = 0; i < settings.colors.length; i++) {
                element = settings.colors[i];

                const folderRule = settings.gui.addFolder(element.color).close();
                folderRule.onFinishChange((value) => {
                        console.log("??");
                    });
                if (!element.onOff) {
                    folderRule.hide();
                }
            }


        }

        randomRules = () => {
            for (var i = 0; i < settings.colors.length; i++) {
                settings.rules[i] = [];
                for (var j = 0; j < settings.colors.length; j++) {
                    settings.rules[i][j] = Math.random() * 2 - 1; // range from -1.0 to 1.0
                }
            }
        };

        draw = (x, y, c, s) => {
            m.fillStyle = c;
            m.fillRect(x, y, s, s);
        };

        atoms = [];
        atom = (x, y, c, s) => {
            return {
                x: x, y: y,
                vx: 0, vy: 0,
                color: c,
                size: s,
            };
        };

        random = () => {
            return Math.random() * 400 + 50;
        };

        create = (number, color, size) => {
            group = [];
            for (let i = 0; i < number; i++) {
                group.push(atom(random(), random(), color, size));
                atoms.push(group[i]);
            }
            return group;
        };

        rule = (atoms1, atoms2, g) => {
            for (let i = 0; i < atoms1.length; i++) {
                fx = 0;
                fy = 0;
                for (let j = 0; j < atoms2.length; j++) {
                    a = atoms1[i];
                    b = atoms2[j];
                    dx = a.x - b.x;
                    dy = a.y - b.y;
                    d = Math.sqrt(dx * dx + dy * dy);
                    if (d > 0 && d < 80) {
                        F = (g * 1) / d;
                        fx += F * dx;
                        fy += F * dy;
                    }
                }
                a.vx = (a.vx + fx) * 0.5;
                a.vy = (a.vy + fy) * 0.5;
                a.x += a.vx;
                a.y += a.vy;

                //push back in
                if (a.x <= 0) { a.vx = -1 * a.vx + 5; }
                else if (a.x >= canvasSize.x - initSize) { a.vx = -1 * a.vx - 5; }
                else if (a.y <= 0) { a.vy = -1 * a.vy + 5; }
                else if (a.y >= canvasSize.y - initSize) { a.vy = -1 * a.vy - 5; }
            }
        };

        applyRules = () => {
            for (var i = 0; i < settings.colors.length; i++) {
                for (var j = 0; j < settings.colors.length; j++) {
                    if (!settings.colors[i].onOff || !settings.colors[j].onOff) {
                        continue;
                    }
                    rule(atomSets[i], atomSets[j], settings.rules[i][j]);
                }
            }
        }

        //--------------setup start-------------
        setupGUI();
        randomRules();

        const initParticleNum = 50;
        const initSize = 10;
        const canvasSize = { x: 500, y: 500 };

        atomSets = [];
        for (i = 0; i < settings.colors.length; i++) {
            atomSets.push(create(initParticleNum, settings.colors[i].color, initSize));
        }




        update = () => {
            if (!settings.Pause) {
                applyRules();
            }

            m.clearRect(0, 0, 500, 500);
            draw(0, 0, "black", 500);
            for (i = 0; i < settings.colors.length; i++) {
                if (!settings.colors[i].onOff) { continue; }

                for (j = 0; j < atomSets[i].length; j++) {
                    draw(atomSets[i][j].x, atomSets[i][j].y, atomSets[i][j].color, atomSets[i][j].size);
                }
            }
            requestAnimationFrame(update);
        };

        update();
    </script>

</body>

</html>